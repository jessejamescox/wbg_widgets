<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 350" width="100%" height="100%">
  <defs>
    <style>
      .hx-box { fill: #f5f7fa; stroke: #ffffff; stroke-width: 2; }
      .hx-duct { fill: #cfd8dc; stroke: #7f8c8d; stroke-width: 2; }
      .hx-wheel { fill: none; stroke: #7f8c8d; stroke-width: 2; }
      .hx-wheel-active { animation: spin 4s linear infinite; }
      .hx-text { fill: #2c3e50; font-family: Arial, sans-serif; font-size: 14px; }
      .hx-label { fill: #eceff1; font-family: Arial, sans-serif; font-size: 11px; }
      .hx-value { fill: #1976d2; font-family: Arial, monospace; font-size: 12px; font-weight: bold; }
      .hx-value-warm { fill: #e74c3c; }
      .hx-value-cold { fill: #1976d2; }
      .hx-arrow { fill: none; stroke-width: 2; }
      .hx-arrow-supply { stroke: #1976d2; }
      .hx-arrow-exhaust { stroke: #e74c3c; }
      .hx-flow { opacity: 0.3; }
      .hx-flow-active { animation: flow 2s linear infinite; }
      .status-ok { fill: #27ae60; }
      .status-running { fill: #1976d2; }
      .status-alarm { fill: #e74c3c; }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      @keyframes flow {
        0% { opacity: 0.1; }
        50% { opacity: 0.5; }
        100% { opacity: 0.1; }
      }
    </style>
  </defs>

  <!-- Title -->
  <text class="hx-text" x="225" y="25" text-anchor="middle" font-size="16" font-weight="bold">
    Heat Recovery Unit
  </text>

  <!-- Supply Air Path (Bottom) -->
  <!-- Outside Air In -->
  <rect class="hx-duct" x="20" y="140" width="80" height="40"/>
  <text class="hx-label" x="60" y="133" text-anchor="middle">OUTSIDE AIR</text>
  <text id="oaTemp" class="hx-value hx-value-cold" x="60" y="163" text-anchor="middle" font-size="11">35°F</text>

  <!-- Supply Air Out -->
  <rect class="hx-duct" x="350" y="140" width="80" height="40"/>
  <text class="hx-label" x="390" y="133" text-anchor="middle">SUPPLY AIR</text>
  <text id="saTemp" class="hx-value hx-value-warm" x="390" y="163" text-anchor="middle" font-size="11">62°F</text>

  <!-- Exhaust Air Path (Top) -->
  <!-- Return Air In -->
  <rect class="hx-duct" x="350" y="60" width="80" height="40"/>
  <text class="hx-label" x="390" y="53" text-anchor="middle">RETURN AIR</text>
  <text id="raTemp" class="hx-value hx-value-warm" x="390" y="83" text-anchor="middle" font-size="11">70°F</text>

  <!-- Exhaust Air Out -->
  <rect class="hx-duct" x="20" y="60" width="80" height="40"/>
  <text class="hx-label" x="60" y="53" text-anchor="middle">EXHAUST AIR</text>
  <text id="eaTemp" class="hx-value hx-value-cold" x="60" y="83" text-anchor="middle" font-size="11">43°F</text>

  <!-- Heat Exchanger Core -->
  <rect class="hx-box" x="150" y="50" width="150" height="140" rx="5"/>
  <text class="hx-label" x="225" y="125" text-anchor="middle" font-size="10">ENERGY RECOVERY</text>

  <!-- Energy Wheel Visualization -->
  <g id="wheel" transform="translate(225, 100)">
    <circle class="hx-wheel" cx="0" cy="0" r="40"/>
    <circle class="hx-wheel" cx="0" cy="0" r="30"/>
    <circle class="hx-wheel" cx="0" cy="0" r="20"/>
    <circle class="hx-wheel" cx="0" cy="0" r="10"/>
    <line class="hx-wheel" x1="-40" y1="0" x2="40" y2="0"/>
    <line class="hx-wheel" x1="0" y1="-40" x2="0" y2="40"/>
    <line class="hx-wheel" x1="-28" y1="-28" x2="28" y2="28"/>
    <line class="hx-wheel" x1="-28" y1="28" x2="28" y2="-28"/>
  </g>

  <!-- Airflow Arrows -->
  <g id="supplyFlow">
    <path class="hx-arrow hx-arrow-supply" d="M 110 160 L 140 160 M 135 155 L 140 160 L 135 165"/>
    <circle class="hx-flow hx-flow-active" fill="#1976d2" cx="120" cy="160" r="3"/>
    <path class="hx-arrow hx-arrow-supply" d="M 310 160 L 340 160 M 335 155 L 340 160 L 335 165"/>
    <circle class="hx-flow hx-flow-active" fill="#1976d2" cx="320" cy="160" r="3" style="animation-delay: 1s"/>
  </g>

  <g id="exhaustFlow">
    <path class="hx-arrow hx-arrow-exhaust" d="M 340 80 L 310 80 M 315 75 L 310 80 L 315 85"/>
    <circle class="hx-flow hx-flow-active" fill="#e74c3c" cx="330" cy="80" r="3" style="animation-delay: 0.5s"/>
    <path class="hx-arrow hx-arrow-exhaust" d="M 140 80 L 110 80 M 115 75 L 110 80 L 115 85"/>
    <circle class="hx-flow hx-flow-active" fill="#e74c3c" cx="120" cy="80" r="3" style="animation-delay: 1.5s"/>
  </g>

  <!-- Data Panel -->
  <rect fill="#2c3e50" stroke="#f5f7fa" stroke-width="1" x="20" y="210" width="410" height="120" rx="5"/>

  <!-- Row 1 -->
  <text class="hx-label" x="35" y="235">Outside Air:</text>
  <text id="oaTempData" class="hx-value hx-value-cold" x="35" y="255">35°F</text>

  <text class="hx-label" x="140" y="235">Supply Air:</text>
  <text id="saTempData" class="hx-value hx-value-warm" x="140" y="255">62°F</text>

  <text class="hx-label" x="240" y="235">Temp Rise:</text>
  <text id="tempRise" class="hx-value" x="240" y="255">27°F</text>

  <text class="hx-label" x="330" y="235">Efficiency:</text>
  <text id="efficiency" class="hx-value" x="330" y="255">77%</text>

  <!-- Row 2 -->
  <text class="hx-label" x="35" y="275">Return Air:</text>
  <text id="raTempData" class="hx-value hx-value-warm" x="35" y="295">70°F</text>

  <text class="hx-label" x="140" y="275">Exhaust Air:</text>
  <text id="eaTempData" class="hx-value hx-value-cold" x="140" y="295">43°F</text>

  <text class="hx-label" x="240" y="275">Temp Drop:</text>
  <text id="tempDrop" class="hx-value" x="240" y="295">27°F</text>

  <text class="hx-label" x="330" y="275">Status:</text>
  <g id="statusIndicator">
    <circle id="statusLight" class="status-ok" cx="373" cy="287" r="5"/>
    <text id="statusText" class="hx-value" x="383" y="295">Off</text>
  </g>

  <!-- Row 3 -->
  <text class="hx-label" x="35" y="310">Supply Flow:</text>
  <text id="supplyFlow" class="hx-value" x="35" y="325">0 CFM</text>

  <text class="hx-label" x="140" y="310">Exhaust Flow:</text>
  <text id="exhaustFlow" class="hx-value" x="140" y="325">0 CFM</text>

  <text class="hx-label" x="240" y="310">Energy Saved:</text>
  <text id="energySaved" class="hx-value" x="240" y="325">0 kW</text>

  <script><![CDATA[
//!export-start
let _pn_oaTemp = 35;
let _pn_raTemp = 70;
let _pn_saTemp = 62;
let _pn_eaTemp = 43;
let _pn_supplyAirflow = 0;
let _pn_exhaustAirflow = 0;
let _pn_wheelSpeed = 0;
let _pb_enabled = false;
let _pb_alarmActive = false;
let _pn_efficiency = 0.77;
let _pn_energySaved = 0;
//!export-end

function init() {
  update();
}

// Exported variables for FUXA

    function updateDisplay() {
      // Calculate heat exchanger performance
let tempDiff = _pn_raTemp - _pn_oaTemp;

      if (_pb_enabled && _pn_supplyAirflow > 0) {
        // Calculate outlet temperatures based on _pn_efficiency
let tempTransfer = tempDiff * _pn_efficiency;
        _pn_saTemp = _pn_oaTemp + tempTransfer;
        _pn_eaTemp = _pn_raTemp - tempTransfer;
      } else {
        // No heat transfer when off
        _pn_saTemp = _pn_oaTemp;
        _pn_eaTemp = _pn_raTemp;
      }
let tempRise = _pn_saTemp - _pn_oaTemp;
let tempDrop = _pn_raTemp - _pn_eaTemp;

      // Update temperature displays
      document.getElementById('oaTemp').textContent = _pn_oaTemp.toFixed(0) + '°F';
      document.getElementById('raTemp').textContent = _pn_raTemp.toFixed(0) + '°F';
      document.getElementById('saTemp').textContent = _pn_saTemp.toFixed(0) + '°F';
      document.getElementById('eaTemp').textContent = _pn_eaTemp.toFixed(0) + '°F';
      document.getElementById('oaTempData').textContent = _pn_oaTemp.toFixed(0) + '°F';
      document.getElementById('raTempData').textContent = _pn_raTemp.toFixed(0) + '°F';
      document.getElementById('saTempData').textContent = _pn_saTemp.toFixed(0) + '°F';
      document.getElementById('eaTempData').textContent = _pn_eaTemp.toFixed(0) + '°F';

      // Update calculated values
      document.getElementById('tempRise').textContent = tempRise.toFixed(0) + '°F';
      document.getElementById('tempDrop').textContent = tempDrop.toFixed(0) + '°F';
      document.getElementById('efficiency').textContent = (_pn_efficiency * 100).toFixed(0) + '%';

      // Update airflows
      document.getElementById('supplyFlow').textContent = _pn_supplyAirflow.toFixed(0) + ' CFM';
      document.getElementById('exhaustFlow').textContent = _pn_exhaustAirflow.toFixed(0) + ' CFM';

      // Calculate energy savings (rough estimate)
      // Energy (kW) = CFM × temp_rise × 1.08 / 3412 (BTU to kW conversion)

      if (_pb_enabled && _pn_supplyAirflow > 0) {
let btuh = _pn_supplyAirflow * tempRise * 1.08;
        _pn_energySaved = btuh / 3412; // Convert to kW
      }
      document.getElementById('energySaved').textContent = _pn_energySaved.toFixed(1) + ' kW';

      // Update status
const statusLight = document.getElementById('statusLight');
const statusText = document.getElementById('statusText');

      if (_pb_alarmActive) {
        statusLight.setAttribute('class', 'status-alarm');
        statusText.textContent = 'Alarm';
        statusText.style.fill = '#e74c3c';
      } else if (_pb_enabled && _pn_supplyAirflow > 0) {
        statusLight.setAttribute('class', 'status-running');
        statusText.textContent = 'Running';
        statusText.style.fill = '#27ae60';
      } else {
        statusLight.setAttribute('class', 'status-ok');
        statusText.textContent = 'Off';
        statusText.style.fill = '#7f8c8d';
      }

      // Wheel animation
const wheel = document.getElementById('wheel');
      if (_pb_enabled && _pn_supplyAirflow > 0) {
        wheel.classList.add('hx-wheel-active');
      } else {
        wheel.classList.remove('hx-wheel-active');
      }

      // Show/hide flow arrows
const supplyFlowGroup = document.getElementById('supplyFlow');
const exhaustFlowGroup = document.getElementById('exhaustFlow');
      if (_pb_enabled && _pn_supplyAirflow > 0) {
        supplyFlowGroup.style.display = 'block';
        exhaustFlowGroup.style.display = 'block';
      } else {
        supplyFlowGroup.style.display = 'none';
        exhaustFlowGroup.style.display = 'none';
      }
    }

    // Initialize display
    updateDisplay();

    // Update display every 100ms
    setInterval(updateDisplay, 100);

function putValue(id, value) {
  if (id === '_pn_oaTemp') {
    _pn_oaTemp = Number(value) || 0;
    update();
  } else if (id === '_pn_raTemp') {
    _pn_raTemp = Number(value) || 0;
    update();
  } else if (id === '_pn_saTemp') {
    _pn_saTemp = Number(value) || 0;
    update();
  } else if (id === '_pn_eaTemp') {
    _pn_eaTemp = Number(value) || 0;
    update();
  } else if (id === '_pn_supplyAirflow') {
    _pn_supplyAirflow = Number(value) || 0;
    update();
  } else if (id === '_pn_exhaustAirflow') {
    _pn_exhaustAirflow = Number(value) || 0;
    update();
  } else if (id === '_pn_wheelSpeed') {
    _pn_wheelSpeed = Number(value) || 0;
    update();
  } else if (id === '_pb_enabled') {
    _pb_enabled = !!value;
    update();
  } else if (id === '_pb_alarmActive') {
    _pb_alarmActive = !!value;
    update();
  } else if (id === '_pn_efficiency') {
    _pn_efficiency = Number(value) || 0;
    update();
  } else if (id === '_pn_energySaved') {
    _pn_energySaved = Number(value) || 0;
    update();
  }
}

init();

]]></script>
</svg>
