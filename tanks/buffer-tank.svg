<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400" id="buffer-tank-widget">
  <defs>
    <!-- Stratification gradients -->
    <linearGradient id="hotLayer" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ff5252;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#ff8a80;stop-opacity:0.8" />
    </linearGradient>
    <linearGradient id="warmLayer" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ffa726;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#ffb74d;stop-opacity:0.7" />
    </linearGradient>
    <linearGradient id="coolLayer" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#42a5f5;stop-opacity:0.8" />
      <stop offset="100%" style="stop-color:#64b5f6;stop-opacity:0.7" />
    </linearGradient>
    <linearGradient id="tankInsulation" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#8d6e63;stop-opacity:0.9" />
      <stop offset="50%" style="stop-color:#a1887f;stop-opacity:0.95" />
      <stop offset="100%" style="stop-color:#8d6e63;stop-opacity:0.9" />
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="300" height="400" fill="#f5f5f5"/>

  <!-- Title -->
  <text x="150" y="25" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#333">
    Buffer Tank (Thermal Storage)
  </text>

  <!-- Tank Container with Insulation -->
  <g id="tank-container">
    <!-- Insulation layer -->
    <rect x="70" y="55" width="160" height="220" fill="url(#tankInsulation)" stroke="#5d4037" stroke-width="3" rx="8"/>

    <!-- Inner tank -->
    <rect x="78" y="63" width="144" height="204" fill="#e0e0e0" stroke="#757575" stroke-width="2" rx="5"/>

    <!-- Thermal stratification layers (animated) -->
    <g id="stratification">
      <!-- Hot layer (top) -->
      <rect id="hot-layer" x="80" y="65" width="140" height="60" fill="url(#hotLayer)" opacity="0.9"/>

      <!-- Warm layer (middle) -->
      <rect id="warm-layer" x="80" y="125" width="140" height="70" fill="url(#warmLayer)" opacity="0.85"/>

      <!-- Cool layer (bottom) -->
      <rect id="cool-layer" x="80" y="195" width="140" height="70" fill="url(#coolLayer)" opacity="0.85"/>
    </g>

    <!-- Supply connection (top - hot) -->
    <g id="supply-connection">
      <rect x="225" y="75" width="40" height="8" fill="#ff5252" stroke="#333" stroke-width="1.5"/>
      <path d="M 265 79 L 275 79 L 270 74 M 265 79 L 275 79 L 270 84" stroke="#333" stroke-width="1.5" fill="none"/>
      <text x="268" y="70" font-family="Arial" font-size="10" text-anchor="middle" fill="#333">SUP</text>
    </g>

    <!-- Return connection (bottom - cool) -->
    <g id="return-connection">
      <rect x="35" y="250" width="40" height="8" fill="#42a5f5" stroke="#333" stroke-width="1.5"/>
      <path d="M 35 254 L 25 254 L 30 249 M 35 254 L 25 254 L 30 259" stroke="#333" stroke-width="1.5" fill="none"/>
      <text x="32" y="245" font-family="Arial" font-size="10" text-anchor="middle" fill="#333">RET</text>
    </g>

    <!-- Charge level indicator -->
    <g id="charge-indicator">
      <rect x="240" y="63" width="35" height="204" fill="#ffffff" stroke="#333" stroke-width="2" rx="5"/>
      <rect id="charge-fill" x="242" y="163" width="31" height="102" fill="#4caf50" rx="3"/>

      <!-- Charge scale -->
      <line x1="240" y1="88" x2="245" y2="88" stroke="#333" stroke-width="1"/>
      <line x1="240" y1="127" x2="245" y2="127" stroke="#333" stroke-width="1"/>
      <line x1="240" y1="166" x2="245" y2="166" stroke="#333" stroke-width="1"/>
      <line x1="240" y1="205" x2="245" y2="205" stroke="#333" stroke-width="1"/>

      <text x="257" y="70" font-family="Arial" font-size="10" text-anchor="middle" fill="#333">CHG</text>
    </g>

    <!-- Temperature scale -->
    <g id="temp-scale">
      <text x="60" y="75" font-family="Arial" font-size="10" text-anchor="end" fill="#ff5252" font-weight="bold">HOT</text>
      <text x="60" y="160" font-family="Arial" font-size="10" text-anchor="end" fill="#ffa726">WARM</text>
      <text x="60" y="255" font-family="Arial" font-size="10" text-anchor="end" fill="#42a5f5" font-weight="bold">COOL</text>
    </g>
  </g>

  <!-- Temperature displays -->
  <g id="temp-displays">
    <!-- Supply temperature -->
    <rect x="20" y="285" width="85" height="40" fill="#ffffff" stroke="#ff5252" stroke-width="2" rx="5"/>
    <text x="62.5" y="300" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">Supply</text>
    <text x="62.5" y="318" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#ff5252">
      <tspan id="supply-temp">180</tspan>°F
    </text>

    <!-- Return temperature -->
    <rect x="115" y="285" width="85" height="40" fill="#ffffff" stroke="#42a5f5" stroke-width="2" rx="5"/>
    <text x="157.5" y="300" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">Return</text>
    <text x="157.5" y="318" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#42a5f5">
      <tspan id="return-temp">120</tspan>°F
    </text>

    <!-- Delta T -->
    <rect x="210" y="285" width="70" height="40" fill="#ffffff" stroke="#333" stroke-width="2" rx="5"/>
    <text x="245" y="300" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">ΔT</text>
    <text x="245" y="318" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#333">
      <tspan id="delta-temp">60</tspan>°F
    </text>
  </g>

  <!-- Info Panel -->
  <g id="info-panel">
    <rect x="20" y="335" width="260" height="55" fill="#ffffff" stroke="#333" stroke-width="2" rx="5"/>

  <script><![CDATA[
//!export-start
let _pn_level = 65;      // Tank level (%)
let _pn_capacity = 1000; // Tank capacity (gallons)
let _pn_temperature = 72; // Temperature (°F)
let _ps_label = "Buffer Tank"; // Tank label
//!export-end

function init() { update(); }

function update() {
  const fillRect = document.getElementById('tankFill');
  const levelText = document.getElementById('levelText');
  const capacityText = document.getElementById('capacityText');
  const tempText = document.getElementById('tempText');
  const labelText = document.getElementById('tankLabel');
  if (!fillRect) return;
  const fillHeight = (_pn_level / 100) * 150;
  fillRect.setAttribute('height', fillHeight);
  fillRect.setAttribute('y', 150 - fillHeight);
  if (levelText) levelText.textContent = _pn_level + '%';
  if (capacityText) capacityText.textContent = Math.round(_pn_capacity * _pn_level / 100) + ' gal';
  if (tempText) tempText.textContent = _pn_temperature + '°F';
  if (labelText) labelText.textContent = _ps_label;
}

function putValue(id, value) {
  if (id === '_pn_level') _pn_level = Number(value) || 0;
  else if (id === '_pn_capacity') _pn_capacity = Number(value) || 0;
  else if (id === '_pn_temperature') _pn_temperature = Number(value) || 0;
  else if (id === '_ps_label') _ps_label = String(value);
  update();
}

init();
]]></script>
</svg>
