<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 110" width="100%" height="100%">
  <defs>
    <style>
      .valve-body { fill: #7f8c8d; stroke: #2c3e50; stroke-width: 2; }
      .valve-stem { fill: #95a5a6; stroke: #2c3e50; stroke-width: 1.5; }
      .pipe { fill: none; stroke: #34495e; stroke-width: 4; }
      .gauge-bg { fill: #ecf0f1; }
      .gauge-fill { fill: #3498db; transition: height 0.5s; }
      .gauge-border { fill: none; stroke: #95a5a6; stroke-width: 1.5; }
      .value-text { font-family: Arial, sans-serif; font-size: 12px; fill: #2c3e50; text-anchor: middle; font-weight: bold; }
      .label-text { font-family: Arial, sans-serif; font-size: 8px; fill: #7f8c8d; text-anchor: middle; }
    </style>
  </defs>

  <!-- Inlet Pipe -->
  <line x1="40" y1="5" x2="40" y2="20" class="pipe"/>

  <!-- Valve Body -->
  <rect x="25" y="20" width="30" height="35" class="valve-body" rx="3"/>

  <!-- Valve Stem with position indicator -->
  <rect id="valveStem" x="37" y="25" width="6" height="25" class="valve-stem" rx="1"/>
  <circle id="stemTop" cx="40" cy="27" r="4" fill="#34495e"/>

  <!-- Outlet Pipe -->
  <line x1="40" y1="55" x2="40" y2="70" class="pipe"/>

  <!-- Position Gauge -->
  <rect x="5" y="20" width="12" height="50" class="gauge-bg" rx="2"/>
  <rect id="gaugeFill" x="5" y="70" width="12" height="0" class="gauge-fill"/>
  <rect x="5" y="20" width="12" height="50" class="gauge-border" rx="2"/>

  <!-- Scale Marks -->
  <text x="19" y="24" class="label-text">100</text>
  <text x="19" y="48" class="label-text">50</text>
  <text x="19" y="72" class="label-text">0</text>

  <!-- Value Display -->
  <rect x="15" y="80" width="50" height="22" fill="#2c3e50" rx="3"/>
  <text id="valueText" x="40" y="95" class="value-text" fill="#ffffff">0%</text>
  <text x="40" y="105" class="label-text">POSITION</text>

  <script><![CDATA[
//!export-start
let _pn_position = 0;    // Valve position (0-100%)
let _pn_command = 0;     // Commanded position (0-100%)
let _pn_feedback = 0;    // Actual position feedback (0-100%)
//!export-end

function init() {
  update();
}

    function update() {
const gaugeFill = document.getElementById('gaugeFill');
const valueText = document.getElementById('valueText');
const stemTop = document.getElementById('stemTop');

  if (!gaugeFill || !valueText || !stemTop) return;

      // Use _pn_feedback if available, otherwise use _pn_command
let displayPos = _pn_feedback > 0 ? _pn_feedback : _pn_position;
      displayPos = Math.max(0, Math.min(100, displayPos));

      // Update gauge fill (inverted - fills from bottom)
let fillHeight = (displayPos / 100) * 50;
      gaugeFill.setAttribute('y', 70 - fillHeight);
      gaugeFill.setAttribute('height', fillHeight);

      // Update stem _pn_position
let stemY = 27 + (25 * (1 - displayPos / 100));
      stemTop.setAttribute('cy', stemY);

      // Update value display
      valueText.textContent = Math.round(displayPos) + '%';

      // Color based on _pn_position
      if (displayPos < 10) {
        gaugeFill.setAttribute('fill', '#e74c3c');
      } else if (displayPos > 90) {
        gaugeFill.setAttribute('fill', '#27ae60');
      } else {
        gaugeFill.setAttribute('fill', '#3498db');
      }
    }

function putValue(id, value) {
  if (id === '_pn_position') {
    _pn_position = Number(value) || 0;
    update();
  } else if (id === '_pn_command') {
    _pn_command = Number(value) || 0;
    update();
  } else if (id === '_pn_feedback') {
    _pn_feedback = Number(value) || 0;
    update();
  }
}

init();

]]></script>
</svg>
