<?xml version="1.0" encoding="UTF-8"?>
<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <style>
      .card-bg {
        fill: white;
        stroke: #ccc;
        stroke-width: 2;
      }
      .header-bg {
        fill: #673AB7;
      }
      .header-text {
        fill: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        font-weight: bold;
      }
      .section-label {
        fill: #666;
        font-family: Arial, sans-serif;
        font-size: 10px;
        text-transform: uppercase;
      }
      .value-text {
        fill: #333;
        font-family: Arial, sans-serif;
        font-size: 14px;
        font-weight: bold;
      }
      .time-text {
        fill: #673AB7;
        font-family: 'Courier New', monospace;
        font-size: 16px;
        font-weight: bold;
      }
      .status-badge {
        transition: all 0.3s;
      }
      .status-badge-rect {
        fill: #4CAF50;
        stroke: none;
      }
      .status-badge-rect.override {
        fill: #FF9800;
      }
      .status-badge-text {
        fill: white;
        font-family: Arial, sans-serif;
        font-size: 10px;
        font-weight: bold;
        text-anchor: middle;
      }
      .divider {
        stroke: #e0e0e0;
        stroke-width: 1;
      }
      .icon-text {
        fill: #999;
        font-family: Arial, sans-serif;
        font-size: 18px;
      }
      .secondary-text {
        fill: #999;
        font-family: Arial, sans-serif;
        font-size: 11px;
      }
      @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }
      .override-indicator {
        animation: blink 1.5s infinite;
      }
    </style>
  </defs>

  <!-- Card Background -->
  <rect class="card-bg" x="0" y="0" width="280" height="180" rx="5"/>

  <!-- Header -->
  <rect class="header-bg" x="0" y="0" width="280" height="30" rx="5"/>
  <text class="header-text" x="10" y="20">SCHEDULE</text>

  <!-- Status Badge -->
  <g class="status-badge" id="statusBadge">
    <rect class="status-badge-rect" id="statusBadgeRect" x="200" y="7" width="70" height="16" rx="8"/>
    <text class="status-badge-text" id="statusBadgeText" x="235" y="18">ACTIVE</text>
  </g>

  <!-- Current Period Section -->
  <text class="section-label" x="15" y="50">CURRENT PERIOD</text>
  <text class="icon-text" x="15" y="73">⏰</text>
  <text class="value-text" id="currentPeriod" x="45" y="73">Morning</text>

  <!-- Current Time -->
  <text class="time-text" id="currentTime" x="15" y="95">08:45</text>
  <text class="secondary-text" id="currentTemp" x="80" y="95">Heating to 72°F</text>

  <!-- Divider -->
  <line class="divider" x1="15" y1="105" x2="265" y2="105"/>

  <!-- Next Event Section -->
  <text class="section-label" x="15" y="122">NEXT EVENT</text>
  <text class="icon-text" x="15" y="143">▶</text>
  <text class="value-text" id="nextPeriod" x="45" y="143">Day</text>
  <text class="secondary-text" id="nextTime" x="45" y="158">at 09:00 - 68°F</text>

  <!-- Override Indicator -->
  <g id="overrideIndicator" style="opacity: 0;">
    <circle class="override-indicator" cx="250" cy="138" r="8" fill="#FF9800"/>
    <text x="250" y="143" text-anchor="middle" fill="white" font-size="12px" font-weight="bold">!</text>
  </g>

  <script><![CDATA[
//!export-start
let _ps_currentPeriodTagId = '';
let _ps_currentTempTagId = '';
let _ps_nextPeriodTagId = '';
let _ps_nextTimeTagId = '';
let _ps_nextTempTagId = '';
let _ps_overrideActiveTagId = '';
let _ps_currentTimeTagId = '';
let _ps_currentPeriodName = 'Morning';
let _pn_currentTemp = 72.0;
let _ps_currentTimeStr = '08:45';
let _ps_nextPeriodName = 'Day';
let _ps_nextTimeStr = '09:00';
let _pn_nextTemp = 68.0;
let _pb_isOverrideActive = false;
let _ps_units = '°F';
//!export-end

function init() {
  update();
}

(function() {
      // FUXA Integration Variables

      // Current values

      // DOM Elements
const currentPeriod = document.getElementById('currentPeriod');
const currentTime = document.getElementById('currentTime');
const currentTempEl = document.getElementById('currentTemp');
const nextPeriod = document.getElementById('nextPeriod');
const nextTime = document.getElementById('nextTime');
const statusBadgeRect = document.getElementById('statusBadgeRect');
const statusBadgeText = document.getElementById('statusBadgeText');
const overrideIndicator = document.getElementById('overrideIndicator');

      // Format time string
      function formatTime(value) {
        // If value is a number (minutes since midnight), convert to HH:MM
        if (typeof value === 'number') {
let hours = Math.floor(value / 60);
let minutes = value % 60;
          return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
        }
        return value;
      }

      // Update all visuals
      function updateVisuals() {
        currentPeriod.textContent = _ps_currentPeriodName;
        currentTime.textContent = formatTime(_ps_currentTimeStr);
        currentTempEl.textContent = 'Heating to ' + _pn_currentTemp.toFixed(1) + _ps_units;

        nextPeriod.textContent = _ps_nextPeriodName;
        nextTime.textContent = 'at ' + formatTime(_ps_nextTimeStr) + ' - ' + _pn_nextTemp.toFixed(1) + _ps_units;

        if (_pb_isOverrideActive) {
          statusBadgeRect.classList.add('override');
          statusBadgeText.textContent = 'OVERRIDE';
          overrideIndicator.style.opacity = '1';
        } else {
          statusBadgeRect.classList.remove('override');
          statusBadgeText.textContent = 'ACTIVE';
          overrideIndicator.style.opacity = '0';
        }
      }

      // Update current time every minute
      function updateCurrentTime() {
let now = new Date();
let hours = now.getHours();
let minutes = now.getMinutes();
        _ps_currentTimeStr = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
        updateVisuals();
      }

      // Start clock if not receiving time from FUXA
let clockInterval = setInterval(function() {
        if (!_ps_currentTimeTagId) {
          updateCurrentTime();
        }
      }, 60000); // Update every minute

      // FUXA Integration Functions
      window.svgSetValue = function(sigid, value) {
        if (sigid === _ps_currentPeriodTagId) {
          _ps_currentPeriodName = String(value);
        } else if (sigid === _ps_currentTempTagId) {
          _pn_currentTemp = parseFloat(value);
        } else if (sigid === _ps_currentTimeTagId) {
          _ps_currentTimeStr = value;
        } else if (sigid === _ps_nextPeriodTagId) {
          _ps_nextPeriodName = String(value);
        } else if (sigid === _ps_nextTimeTagId) {
          _ps_nextTimeStr = value;
        } else if (sigid === _ps_nextTempTagId) {
          _pn_nextTemp = parseFloat(value);
        } else if (sigid === _ps_overrideActiveTagId) {
          _pb_isOverrideActive = (parseFloat(value) > 0);
        }

        updateVisuals();
      };

      window.svgGetProperty = function(name) {
        if (name === 'currentPeriodVariableId') return _ps_currentPeriodTagId;
        if (name === 'currentTempVariableId') return _ps_currentTempTagId;
        if (name === 'currentTimeVariableId') return _ps_currentTimeTagId;
        if (name === 'nextPeriodVariableId') return _ps_nextPeriodTagId;
        if (name === 'nextTimeVariableId') return _ps_nextTimeTagId;
        if (name === 'nextTempVariableId') return _ps_nextTempTagId;
        if (name === 'overrideActiveVariableId') return _ps_overrideActiveTagId;
        if (name === '_ps_units') return _ps_units;
        return null;
      };

      window.svgSetProperty = function(name, value) {
        if (name === 'currentPeriodVariableId') {
          _ps_currentPeriodTagId = value;
        } else if (name === 'currentTempVariableId') {
          _ps_currentTempTagId = value;
        } else if (name === 'currentTimeVariableId') {
          _ps_currentTimeTagId = value;
        } else if (name === 'nextPeriodVariableId') {
          _ps_nextPeriodTagId = value;
        } else if (name === 'nextTimeVariableId') {
          _ps_nextTimeTagId = value;
        } else if (name === 'nextTempVariableId') {
          _ps_nextTempTagId = value;
        } else if (name === 'overrideActiveVariableId') {
          _ps_overrideActiveTagId = value;
        } else if (name === '_ps_units') {
          _ps_units = value;
          updateVisuals();
        }
      };

      // Initialize
      updateCurrentTime();
      updateVisuals();

      // Cleanup on unload
      window.addEventListener('unload', function() {
        clearInterval(clockInterval);
      });
    })();

function putValue(id, value) {
  if (id === '_ps_currentPeriodTagId') {
    _ps_currentPeriodTagId = String(value) || "";
    update();
  } else if (id === '_ps_currentTempTagId') {
    _ps_currentTempTagId = String(value) || "";
    update();
  } else if (id === '_ps_nextPeriodTagId') {
    _ps_nextPeriodTagId = String(value) || "";
    update();
  } else if (id === '_ps_nextTimeTagId') {
    _ps_nextTimeTagId = String(value) || "";
    update();
  } else if (id === '_ps_nextTempTagId') {
    _ps_nextTempTagId = String(value) || "";
    update();
  } else if (id === '_ps_overrideActiveTagId') {
    _ps_overrideActiveTagId = String(value) || "";
    update();
  } else if (id === '_ps_currentTimeTagId') {
    _ps_currentTimeTagId = String(value) || "";
    update();
  } else if (id === '_ps_currentPeriodName') {
    _ps_currentPeriodName = String(value) || "";
    update();
  } else if (id === '_pn_currentTemp') {
    _pn_currentTemp = Number(value) || 0;
    update();
  } else if (id === '_ps_currentTimeStr') {
    _ps_currentTimeStr = String(value) || "";
    update();
  } else if (id === '_ps_nextPeriodName') {
    _ps_nextPeriodName = String(value) || "";
    update();
  } else if (id === '_ps_nextTimeStr') {
    _ps_nextTimeStr = String(value) || "";
    update();
  } else if (id === '_pn_nextTemp') {
    _pn_nextTemp = Number(value) || 0;
    update();
  } else if (id === '_pb_isOverrideActive') {
    _pb_isOverrideActive = !!value;
    update();
  } else if (id === '_ps_units') {
    _ps_units = String(value) || "";
    update();
  }
}

init();

]]></script>
</svg>
