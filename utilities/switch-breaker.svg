<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 450" id="switch-breaker">
  <defs>
    <style>
      .meter-bg { fill: #1a1a2e; stroke: #16213e; stroke-width: 2; }
      .title-text { fill: #00d4ff; font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; }
      .label-text { fill: #a0a0a0; font-family: Arial, sans-serif; font-size: 12px; }
      .value-text { fill: #ffffff; font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold; }
      .unit-text { fill: #a0a0a0; font-family: Arial, sans-serif; font-size: 14px; }
      .status-ok { fill: #00ff00; }
      .status-warning { fill: #ffaa00; }
      .status-alarm { fill: #ff0000; }
      .status-off { fill: #666666; }
      .breaker-body { fill: #2a2a3e; stroke: #404060; stroke-width: 2; }
      .switch-handle { fill: #606080; stroke: #404060; stroke-width: 2; }
      .contact-closed { stroke: #00ff00; stroke-width: 4; }
      .contact-open { stroke: #ff0000; stroke-width: 4; stroke-dasharray: 5,5; }
    </style>
  </defs>

  <!-- Background -->
  <rect class="meter-bg" x="10" y="10" width="380" height="430" rx="10"/>

  <!-- Title -->
  <text class="title-text" x="200" y="35" text-anchor="middle">CIRCUIT BREAKER</text>

  <!-- Status Indicator -->
  <circle id="statusIndicator" class="status-ok" cx="370" cy="25" r="8"/>

  <!-- Breaker Name/ID -->
  <g id="breakerID">
    <text class="label-text" x="200" y="60" text-anchor="middle">BREAKER ID</text>
    <text id="breakerName" class="value-text" x="200" y="82" text-anchor="middle" font-size="16">CB-001</text>
  </g>

  <!-- Visual Breaker Representation -->
  <g id="breakerVisual" transform="translate(200, 180)">
    <!-- Breaker Body -->
    <rect class="breaker-body" x="-60" y="-80" width="120" height="160" rx="10"/>

    <!-- Trip Indicator -->
    <circle id="tripIndicator" class="status-off" cx="0" cy="-50" r="8"/>
    <text class="label-text" x="0" y="-28" text-anchor="middle">TRIP</text>

    <!-- Switch Handle -->
    <g id="switchHandle">
      <rect class="switch-handle" x="-15" y="-10" width="30" height="60" rx="5"/>
      <circle class="status-off" cx="0" cy="20" r="8"/>
    </g>

    <!-- Position Labels -->
    <text class="label-text" x="-45" y="-5" text-anchor="end">ON</text>
    <text class="label-text" x="45" y="45" text-anchor="start">OFF</text>

    <!-- Contacts Visualization -->
    <g transform="translate(0, 100)">
      <line id="contactLine" class="contact-open" x1="-30" y1="-10" x2="30" y2="-10"/>
      <circle class="status-off" cx="-30" cy="-10" r="5"/>
      <circle class="status-off" cx="30" cy="-10" r="5"/>
    </g>
  </g>

  <!-- Status Display -->
  <g id="statusDisplay">
    <rect class="meter-bg" x="25" y="280" width="350" height="50" rx="5"/>
    <text class="label-text" x="200" y="300" text-anchor="middle">STATUS</text>
    <text id="statusText" class="value-text" x="200" y="322" text-anchor="middle" fill="#666666">OFF</text>
  </g>

  <!-- Current Display -->
  <g id="currentDisplay">
    <rect class="meter-bg" x="25" y="345" width="165" height="80" rx="5"/>
    <text class="label-text" x="107.5" y="365" text-anchor="middle">CURRENT</text>
    <text id="currentValue" class="value-text" x="107.5" y="395" text-anchor="middle">0.0</text>
    <text class="unit-text" x="107.5" y="415" text-anchor="middle">A</text>
  </g>

  <!-- Rating Display -->
  <g id="ratingDisplay">
    <rect class="meter-bg" x="210" y="345" width="165" height="80" rx="5"/>
    <text class="label-text" x="292.5" y="365" text-anchor="middle">RATING</text>
    <text id="ratingValue" class="value-text" x="292.5" y="395" text-anchor="middle">100</text>
    <text class="unit-text" x="292.5" y="415" text-anchor="middle">A</text>
  </g>

  <script><![CDATA[
//!export-start
let _pn_currentRating = 100;
let _pb_isOn = false;
let _pb_isTripped = false;
//!export-end

function init() {
  update();
}

// FUXA Variable Mappings
let variables = {
      status: 'breaker_status',           // boolean (true=ON, false=OFF)
      current: 'breaker_current',         // Amps
      rating: 'breaker_rating',           // Amps (max rating)
      tripped: 'breaker_tripped',         // boolean
      name: 'breaker_name',               // string
      command: 'breaker_command'          // boolean (control)
    };

    // Configuration
let config = {
      tripThreshold: 0.9,    // 90% of rating
      warnThreshold: 0.75    // 75% of rating
    };

    // Update function called by FUXA
    function updateValues(tag, value) {
      try {
        switch(tag) {
          case variables.status:
            updateStatus(value);
            break;
          case variables.current:
            updateCurrent(value);
            break;
          case variables.rating:
            updateRating(value);
            break;
          case variables.tripped:
            updateTripped(value);
            break;
          case variables.name:
            updateName(value);
            break;
          case variables.command:
            handleCommand(value);
            break;
        }
      } catch(e) {
        console.error('Error updating breaker:', e);
      }
    }

    function updateStatus(value) {
      _pb_isOn = Boolean(value);
      updateBreakerVisualization();
    }

    function updateCurrent(value) {
let current = parseFloat(value) || 0;
      document.getElementById('currentValue').textContent = current.toFixed(1);

      // Check for overload
let loadPercent = current / _pn_currentRating;
const valueText = document.getElementById('currentValue');

      if (loadPercent >= config.tripThreshold) {
        valueText.setAttribute('fill', '#ff0000');
      } else if (loadPercent >= config.warnThreshold) {
        valueText.setAttribute('fill', '#ffaa00');
      } else {
        valueText.setAttribute('fill', '#ffffff');
      }

      // Auto-trip if overload and breaker is on
      if (_pb_isOn && loadPercent >= 1.0 && !_pb_isTripped) {
        updateTripped(true);
      }
    }

    function updateRating(value) {
      _pn_currentRating = parseFloat(value) || 100;
      document.getElementById('ratingValue').textContent = _pn_currentRating.toFixed(0);
    }

    function updateTripped(value) {
      _pb_isTripped = Boolean(value);
const tripIndicator = document.getElementById('tripIndicator');
const statusIndicator = document.getElementById('statusIndicator');

      if (_pb_isTripped) {
        tripIndicator.setAttribute('class', 'status-alarm');
        statusIndicator.setAttribute('class', 'status-alarm');

        // Add pulsing animation
        tripIndicator.innerHTML = '<animate attributeName="opacity" values="1;0.3;1" dur="1s" repeatCount="indefinite"/>';

        // Force breaker off
        _pb_isOn = false;
        updateBreakerVisualization();
      } else {
        tripIndicator.setAttribute('class', 'status-off');
        tripIndicator.innerHTML = '';

        if (_pb_isOn) {
          statusIndicator.setAttribute('class', 'status-ok');
        } else {
          statusIndicator.setAttribute('class', 'status-off');
        }
      }
    }

    function updateName(value) {
      document.getElementById('breakerName').textContent = value || 'CB-001';
    }

    function handleCommand(value) {
let command = Boolean(value);

      // Cannot close if tripped
      if (command && _pb_isTripped) {
        console.warn('Cannot close breaker - TRIPPED');
        return;
      }

      updateStatus(command);
    }

    function updateBreakerVisualization() {
const handle = document.getElementById('switchHandle');
const statusText = document.getElementById('statusText');
const contactLine = document.getElementById('contactLine');
const statusIndicator = document.getElementById('statusIndicator');

      if (_pb_isOn && !_pb_isTripped) {
        // ON position
        handle.setAttribute('transform', 'rotate(-30)');
        statusText.textContent = 'ON';
        statusText.setAttribute('fill', '#00ff00');
        contactLine.setAttribute('class', 'contact-closed');
        statusIndicator.setAttribute('class', 'status-ok');

        // Animate switch
        animateSwitch(handle, -30);
      } else {
        // OFF position
        handle.setAttribute('transform', 'rotate(30)');
        statusText.textContent = _pb_isTripped ? 'TRIPPED' : 'OFF';
        statusText.setAttribute('fill', _pb_isTripped ? '#ff0000' : '#666666');
        contactLine.setAttribute('class', 'contact-open');

        if (!_pb_isTripped) {
          statusIndicator.setAttribute('class', 'status-off');
        }

        // Animate switch
        animateSwitch(handle, 30);
      }
    }

    function animateSwitch(element, toAngle) {
      // Simple rotation animation
let animateTransform = document.createElementNS('http://www.w3.org/2000/svg', 'animateTransform');
      animateTransform.setAttribute('attributeName', 'transform');
      animateTransform.setAttribute('type', 'rotate');
      animateTransform.setAttribute('from', '0 0 0');
      animateTransform.setAttribute('to', toAngle + ' 0 0');
      animateTransform.setAttribute('dur', '0.3s');
      animateTransform.setAttribute('fill', 'freeze');

      // Remove old animations
let oldAnims = element.getElementsByTagName('animateTransform');
      while (oldAnims.length > 0) {
        element.removeChild(oldAnims[0]);
      }

      element.appendChild(animateTransform);
      animateTransform.beginElement();
    }

    // Initialize
    if (typeof window !== 'undefined') {
      window.updateValues = updateValues;
    }

    // Initialize display
    updateBreakerVisualization();

function putValue(id, value) {
  if (id === '_pn_currentRating') {
    _pn_currentRating = Number(value) || 0;
    update();
  } else if (id === '_pb_isOn') {
    _pb_isOn = !!value;
    update();
  } else if (id === '_pb_isTripped') {
    _pb_isTripped = !!value;
    update();
  }
}

init();

]]></script>
</svg>
